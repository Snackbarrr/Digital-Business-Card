<script type="module">
  import { createClient } from "https://esm.sh/@sanity/client";

  const client = createClient({
    projectId: "ibe92zg9",
    dataset: "production",
    apiVersion: "2023-01-01",
    useCdn: false,
    token: "sk4gDAkyA8lngW0l6IIpM3zL01aUrBQly6q876sSm9bus4WgCvzrNCsTbFMKK5sgpNOEfT1EY9gQcMt4VHE4d7mhHQ6ujxGrUb0UnRYmAzjRU8rRLjanw1WX5PVOGAqgtQPXmZkZVLgBoNH9rKRiv9EXTJb0M169j05LcWCMPAXW2Cjm9C5x"
  });

  const container = document.getElementById('journal');
  const pageSize = 5;
  let loadedCount = 0;
  let isLoading = false;
  let allLoaded = false;

  async function loadPosts() {
    if (isLoading || allLoaded) return;
    isLoading = true;

    const loader = document.createElement('div');
    loader.className = 'loader';
    loader.textContent = "Loading...";
    container.appendChild(loader);

    try {
      const posts = await client.fetch(`*[_type == "post"] | order(coalesce(publishedAt, _createdAt) desc)[${loadedCount}...${loadedCount + pageSize}]{
        _id,
        title,
        body,
        publishedAt,
        _createdAt,
        "authorName": author->name,
        "imageUrl": mainImage.asset->url
      }`);

      loader.remove();

      if (posts.length === 0) {
        allLoaded = true;
        const endMsg = document.createElement('div');
        endMsg.className = 'loader';
        endMsg.textContent = "No more entries.";
        container.appendChild(endMsg);
        return;
      }

      posts.forEach(post => {
        const dateRaw = post.publishedAt || post._createdAt;
        const date = new Date(dateRaw).toLocaleDateString();

        let bodyText = '';
        if (post.body && Array.isArray(post.body)) {
          bodyText = post.body
            .map(block => block.children.map(child => child.text).join(''))
            .join('\n');
        }

        const article = document.createElement('article');

        const isMobile = window.innerWidth <= 600;
        if (!isMobile) {
          const direction = Math.random() < 0.5 ? -1 : 1;
          const percent = (10 + Math.random() * 10) * direction;
          article.style.transform = `translateX(${percent}%)`;
        } else {
          article.style.transform = "none";
        }

        article.innerHTML = `
          <h2>${post.title}</h2>
          <div class="meta">By ${post.authorName || 'Unknown Author'} â€¢ ${date}</div>
          ${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}">` : ''}
          <p>${bodyText}</p>
        `;
        container.appendChild(article);
      });

      loadedCount += posts.length;
    } catch (err) {
      console.error('Fetch error:', err);
      loader.textContent = "Failed to load entries.";
    } finally {
      isLoading = false;
    }
  }

  loadPosts();

  window.addEventListener('scroll', () => {
    if (
      window.innerHeight + window.scrollY >= document.body.offsetHeight - 300
    ) {
      loadPosts();
    }
  });

  const menuToggle = document.getElementById('menuToggle');
  const mobileNav = document.getElementById('mobileNav');
  menuToggle.addEventListener('click', () => {
    mobileNav.classList.toggle('show');
  });
</script>
